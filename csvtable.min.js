const CSVTABLE_CONFIG = {source: "#source-data",tables: {},filters: [],hooks: {},formatters: {}};(function(CONFIG) {"use strict";const DEFAULT_LOCALE = "en-CA";const state = {source: { headers: [], rows: [] },headersIndex: {},tables: {},selectBindings: {},tableSummaries: {},rowClickSelections: {}};function parseCsvLine(line) {const out = [];let current = "";let quote = null;for (let i = 0; i < line.length; i += 1) {const ch = line[i];if (quote) {if (ch === quote) {if (line[i + 1] === quote) {current += quote;i += 1;} else {quote = null;}} else {current += ch;}} else if (ch === "\"" || ch === "'") {if (current.length === 0) {quote = ch;} else {current += ch;}} else if (ch === ",") {out.push(current.trim());current = "";} else {current += ch;}}out.push(current.trim());return out;}function parseCsv(csvText) {const lines = String(csvText || "").replace(/\r/g, "").split("\n");if (lines.length > 0 && lines[lines.length - 1].trim() === "") {lines.pop();}if (!lines.length || lines[0].trim() === "") {return { headers: [], rows: [] };}const headers = parseCsvLine(lines[0]).map(function(h) { return h.trim(); });const rows = [];for (let i = 1; i < lines.length; i += 1) {if (lines[i].trim() === "") continue;const parsed = parseCsvLine(lines[i]);while (parsed.length < headers.length) parsed.push("");rows.push(parsed.slice(0, headers.length));}return { headers: headers, rows: rows };}function splitOutsideBrackets(value) {const input = String(value || "");const segments = [];let depth = 0;let current = "";for (let i = 0; i < input.length; i += 1) {const ch = input[i];if (ch === "[") depth += 1;if (ch === "]") depth = Math.max(0, depth - 1);if (ch === ";" && depth === 0) {if (current.trim()) segments.push(current.trim());current = "";} else {current += ch;}}if (current.trim()) segments.push(current.trim());return segments;}function parseColumns(value) {const out = [];const segments = splitOutsideBrackets(value);for (let i = 0; i < segments.length; i += 1) {const segment = segments[i];const colonIndex = segment.indexOf(":");if (colonIndex === -1) continue;const key = segment.slice(0, colonIndex).trim();const right = segment.slice(colonIndex + 1).trim();let sourceHeader = right;let options = "";const bracketStart = right.indexOf("[");const bracketEnd = right.lastIndexOf("]");if (bracketStart !== -1 && bracketEnd > bracketStart) {sourceHeader = right.slice(0, bracketStart).trim();options = right.slice(bracketStart + 1, bracketEnd);}const col = {key: key,sourceHeader: sourceHeader,type: "text",decimals: 0,locale: null,format: null,showColTotal: false,showRowTotal: false};if (options.trim()) {options.split(";").forEach(function(pair) {const idx = pair.indexOf(":");if (idx === -1) return;const k = pair.slice(0, idx).trim();const v = pair.slice(idx + 1).trim();if (k === "type") col.type = v === "number" ? "number" : "text";else if (k === "decimals") col.decimals = parseInt(v, 10) || 0;else if (k === "locale") col.locale = v || null;else if (k === "format") col.format = v || null;else if (k === "showColTotal") col.showColTotal = v === "true";else if (k === "showRowTotal") col.showRowTotal = v === "true";});}out.push(col);}return out;}function parseStaticFilters(value) {const out = [];splitOutsideBrackets(value).forEach(function(segment) {let idx;if ((idx = segment.indexOf("<>")) !== -1) {out.push({ column: segment.slice(0, idx).trim(), operator: "neq", value: segment.slice(idx + 2).trim() });} else if ((idx = segment.indexOf("~")) !== -1) {out.push({ column: segment.slice(0, idx).trim(), operator: "contains", value: segment.slice(idx + 1).trim() });} else if ((idx = segment.indexOf("=")) !== -1) {out.push({ column: segment.slice(0, idx).trim(), operator: "eq", value: segment.slice(idx + 1).trim() });}});return out;}function parseAgg(value) {const out = {};splitOutsideBrackets(value).forEach(function(segment) {const idx = segment.indexOf(":");if (idx === -1) return;out[segment.slice(0, idx).trim()] = segment.slice(idx + 1).trim().toLowerCase();});return out;}function buildHeaderIndex() {state.headersIndex = {};state.source.headers.forEach(function(h, i) {state.headersIndex[h] = i;});}async function loadSource(source) {try {if (!source) {console.error("[csvtable] Missing source.");return false;}let csvText = "";const sourceEl = document.querySelector(source);if (sourceEl && sourceEl.tagName === "SCRIPT" && sourceEl.type === "text/csv") {csvText = sourceEl.textContent || "";} else {const response = await fetch(source);if (!response.ok) {console.error("[csvtable] Failed to fetch CSV source:", source);return false;}csvText = await response.text();}state.source = parseCsv(csvText);buildHeaderIndex();return true;} catch (err) {console.error("[csvtable] Source load failed.", err);return false;}}function getRowSourceValue(sourceRow, header) {const idx = state.headersIndex[header];if (idx === undefined) return "";return sourceRow[idx] || "";}function staticFilterPredicate(filters) {return function(sourceRow) {for (let i = 0; i < filters.length; i += 1) {const filter = filters[i];const value = getRowSourceValue(sourceRow, filter.column);if (filter.operator === "eq" && value !== filter.value) return false;if (filter.operator === "neq" && value === filter.value) return false;if (filter.operator === "contains" && !String(value).toLowerCase().includes(String(filter.value).toLowerCase())) return false;}return true;};}function applyDynamicFilters(tableState, mappedRows) {const bindings = tableState.filters || [];if (!bindings.length) return mappedRows;return mappedRows.filter(function(rowObj) {for (let i = 0; i < bindings.length; i += 1) {const b = bindings[i];if (b.select) {const select = document.getElementById(b.select);if (!select) continue;const selected = select.value;if (selected === "" || selected === "All") continue;if ((rowObj._source[b.column] || "") !== selected) return false;} else if (b.trigger === "rowClick") {const key = b.table + "|" + b.column + "|" + b.sourceTable + "|" + b.sourceColumn;const selected = state.rowClickSelections[key] || "";if (selected === "") continue;if ((rowObj._source[b.column] || "") !== selected) return false;}}return true;});}function getPagedRows(tableState, sortedRows) {if (!tableState.pager.enabled) {tableState.pager.pageCount = 1;tableState.pager.currentPage = 1;return sortedRows;}const rowsPerPage = Math.max(1, parseInt(tableState.pager.rowsPerPage, 10) || 10);const pageCount = Math.max(1, Math.ceil(sortedRows.length / rowsPerPage));tableState.pager.pageCount = pageCount;tableState.pager.currentPage = Math.max(1, Math.min(tableState.pager.currentPage, pageCount));const start = (tableState.pager.currentPage - 1) * rowsPerPage;return sortedRows.slice(start, start + rowsPerPage);}function getPagerElement(tableEl) {const tableName = tableEl.getAttribute("data-table-name") || "";let pagerEl = document.querySelector('.pager[data-table-name="' + tableName + '"]');if (!pagerEl) {pagerEl = document.createElement("div");pagerEl.className = "pager";pagerEl.setAttribute("data-table-name", tableName);tableEl.insertAdjacentElement("afterend", pagerEl);}return pagerEl;}function renderPager(tableName, totalRows) {const tableState = state.tables[tableName];if (!tableState || !tableState.el) return;const existing = document.querySelector('.pager[data-table-name="' + tableName + '"]');if (!tableState.pager.enabled) {if (existing) existing.remove();return;}const pagerEl = getPagerElement(tableState.el);pagerEl.innerHTML = "";pagerEl.className = "pager pager-container";const info = document.createElement("span");info.className = "pager-info";info.textContent = "Rows " + totalRows;const controls = document.createElement("div");controls.className = "pager-controls";if (tableState.pager.currentPage > 1) {const prev = document.createElement("button");prev.type = "button";prev.className = "pager-btn pager-btn-prev";prev.textContent = "Previous";prev.addEventListener("click", function() {tableState.pager.currentPage -= 1;renderTable(tableName);});controls.appendChild(prev);}const current = document.createElement("span");current.className = "pager-page pager-page-current";current.textContent = tableState.pager.currentPage + " / " + tableState.pager.pageCount;controls.appendChild(current);if (tableState.pager.currentPage < tableState.pager.pageCount) {const next = document.createElement("button");next.type = "button";next.className = "pager-btn pager-btn-next";next.textContent = "Next";next.addEventListener("click", function() {tableState.pager.currentPage += 1;renderTable(tableName);});controls.appendChild(next);}pagerEl.appendChild(info);pagerEl.appendChild(controls);}const AGG_FUNCS = {sum: function(values) {return values.reduce(function(a, b) { return a + (parseFloat(b) || 0); }, 0);},count: function(values) {return values.filter(function(v) { return v !== null && v !== ""; }).length;},mean: function(values) {const nums = values.map(function(v) { return parseFloat(v); }).filter(function(v) { return !isNaN(v); });return nums.length ? AGG_FUNCS.sum(nums) / nums.length : 0;},avg: function(values) { return AGG_FUNCS.mean(values); },min: function(values) {const nums = values.map(function(v) { return parseFloat(v); }).filter(function(v) { return !isNaN(v); });return nums.length ? Math.min.apply(null, nums) : 0;},max: function(values) {const nums = values.map(function(v) { return parseFloat(v); }).filter(function(v) { return !isNaN(v); });return nums.length ? Math.max.apply(null, nums) : 0;},nunique: function(values) {return new Set(values).size;},first: function(values) {return values[0] == null ? "" : values[0];}};function groupAndAggregate(tableState, rows) {if (!tableState.groupBy) return rows.map(function(r) { r._isGroup = false; return r; });const groupColumn = tableState.columns.find(function(c) {return c.key === tableState.groupBy || c.sourceHeader === tableState.groupBy;});if (!groupColumn) return rows;const groups = new Map();rows.forEach(function(row) {const key = row[groupColumn.key];if (!groups.has(key)) groups.set(key, []);groups.get(key).push(row);});const aggRows = [];groups.forEach(function(groupRows, key) {const out = { _source: {}, _isGroup: true };tableState.columns.forEach(function(col) {if (col.key === groupColumn.key) {out[col.key] = key;return;}const fnName = tableState.aggMap[col.sourceHeader] || tableState.aggMap[col.key] || (col.type === "number" ? "sum" : "first");const fn = AGG_FUNCS[fnName] || AGG_FUNCS.first;const values = groupRows.map(function(gr) { return gr[col.key]; });out[col.key] = fn(values);});aggRows.push(out);});return aggRows;}function setupSort(tableName, tableEl) {const ths = Array.from(tableEl.querySelectorAll("thead th.sortable"));if (!ths.length) return;ths.forEach(function(th, index) {th.addEventListener("click", function() {const tState = state.tables[tableName];if (!tState) return;if (tState.sort.columnIndex !== index) {tState.sort.columnIndex = index;tState.sort.direction = "asc";} else if (tState.sort.direction === "asc") {tState.sort.direction = "desc";} else if (tState.sort.direction === "desc") {tState.sort.columnIndex = null;tState.sort.direction = null;} else {tState.sort.direction = "asc";}ths.forEach(function(header) {header.classList.remove("sort-asc", "sort-desc");});if (tState.sort.columnIndex !== null) {const active = ths[tState.sort.columnIndex];if (active) active.classList.add(tState.sort.direction === "asc" ? "sort-asc" : "sort-desc");}renderTable(tableName);});});}function applySort(tableState, rows) {if (tableState.sort.columnIndex === null || !rows.length) return rows;const col = tableState.columns[tableState.sort.columnIndex];if (!col) return rows;const sortType = tableState.sortTypes[tableState.sort.columnIndex] || "text";const dir = tableState.sort.direction === "desc" ? -1 : 1;const sorted = rows.slice();sorted.sort(function(a, b) {const av = a[col.key] == null ? "" : String(a[col.key]);const bv = b[col.key] == null ? "" : String(b[col.key]);if (sortType === "number") {return ((parseFloat(av) || 0) - (parseFloat(bv) || 0)) * dir;}return av.localeCompare(bv) * dir;});return sorted;}function formatNumber(value, locale, decimals) {const num = parseFloat(value);if (isNaN(num)) return "";return new Intl.NumberFormat(locale, {minimumFractionDigits: decimals,maximumFractionDigits: decimals}).format(num);}function formatValue(tableState, col, rawValue) {if (col.type !== "number") return rawValue == null ? "" : String(rawValue);const locale = col.locale || tableState.locale || DEFAULT_LOCALE;const base = parseFloat(rawValue);if (isNaN(base)) return "";if (col.format && tableState.formatters[col.format]) {return String(tableState.formatters[col.format](base));}if (col.format === "currency") {return "$" + formatNumber(base, locale, 2);}if (col.format === "percent") {return formatNumber(base * 100, locale, col.decimals) + "%";}return formatNumber(base, locale, col.decimals);}function computeTotals(tableState, rows) {const totals = {};const rowTotals = [];rows.forEach(function(row) {let rowTotal = 0;tableState.columns.forEach(function(col) {if (col.type !== "number") return;const numeric = parseFloat(row[col.key]);const safe = isNaN(numeric) ? 0 : numeric;totals[col.key] = (totals[col.key] || 0) + safe;if (col.showRowTotal) rowTotal += safe;});rowTotals.push(rowTotal);});return { totals: totals, rowTotals: rowTotals, grandRowTotal: rowTotals.reduce(function(a, b) { return a + b; }, 0) };}function ensureTableParts(tableEl) {let tbody = tableEl.querySelector("tbody");if (!tbody) {tbody = document.createElement("tbody");tableEl.appendChild(tbody);}let tfoot = tableEl.querySelector("tfoot");if (!tfoot) {tfoot = document.createElement("tfoot");tableEl.appendChild(tfoot);}return { tbody: tbody, tfoot: tfoot };}function replaceTemplateTokens(rootNode, tableName, tableState, context) {const pattern = /\{(\w+):(\w+)\}/g;const walker = document.createTreeWalker(rootNode, NodeFilter.SHOW_TEXT, null);const nodes = [];while (walker.nextNode()) nodes.push(walker.currentNode);nodes.forEach(function(node) {const text = node.nodeValue || "";if (!pattern.test(text)) {pattern.lastIndex = 0;return;}pattern.lastIndex = 0;node.nodeValue = text.replace(pattern, function(_, refTable, key) {if (refTable !== tableName) return "";if (key === "RowTotal") {return String(context.rowTotal || 0);}if (key.endsWith("Total")) {const colKey = key.slice(0, -5);const col = tableState.columns.find(function(c) { return c.key === colKey; });if (!col) return "";return formatValue(tableState, col, (context.totals && context.totals[colKey]) || 0);}const col = tableState.columns.find(function(c) { return c.key === key; });if (!col) return "";if (!context.row) return "";return formatValue(tableState, col, context.row[key]);});});}function mapRows(tableState) {const mapped = [];state.source.rows.forEach(function(sourceRow) {const obj = { _source: {} };tableState.columns.forEach(function(col) {const idx = state.headersIndex[col.sourceHeader];if (idx === undefined) {obj[col.key] = "";obj._source[col.sourceHeader] = "";return;}const val = sourceRow[idx] || "";obj[col.key] = val;obj._source[col.sourceHeader] = val;});Object.keys(state.headersIndex).forEach(function(header) {obj._source[header] = getRowSourceValue(sourceRow, header);});mapped.push(obj);});return mapped;}function renderTable(tableName) {try {const tableState = state.tables[tableName];if (!tableState || !tableState.el) return;const parts = ensureTableParts(tableState.el);parts.tbody.innerHTML = "";parts.tfoot.innerHTML = "";const mapped = mapRows(tableState);const staticFiltered = mapped.filter(tableState.staticPredicate);const dynamicFiltered = applyDynamicFilters(tableState, staticFiltered);if (tableState.hooks.onFilter) {tableState.hooks.onFilter({ tableName: tableName, filters: tableState.filters || [], matchCount: dynamicFiltered.length });}const grouped = groupAndAggregate(tableState, dynamicFiltered);const sorted = applySort(tableState, grouped);const pagedRows = getPagedRows(tableState, sorted);const totalsInfo = computeTotals(tableState, sorted);const frag = document.createDocumentFragment();tableState.displayRows = pagedRows;if (!pagedRows.length) {const tr = document.createElement("tr");tr.className = "no-data-row";tr.setAttribute("data-row-index", "0");const td = document.createElement("td");td.colSpan = tableState.columns.length;td.textContent = "No data";tr.appendChild(td);frag.appendChild(tr);} else {pagedRows.forEach(function(row, rowIndex) {let tr;if (tableState.bodyTemplateRow) {tr = tableState.bodyTemplateRow.cloneNode(true);replaceTemplateTokens(tr, tableName, tableState, {row: row,totals: totalsInfo.totals,rowTotal: totalsInfo.rowTotals[rowIndex] || 0});const tds = tr.querySelectorAll("td");tds.forEach(function(td, tdIndex) {const col = tableState.columns[tdIndex];if (col) td.setAttribute("data-col", col.key);});} else {tr = document.createElement("tr");tableState.columns.forEach(function(col) {const td = document.createElement("td");td.setAttribute("data-col", col.key);td.textContent = formatValue(tableState, col, row[col.key]);tr.appendChild(td);});}tr.setAttribute("data-row-index", String(rowIndex));if (row._isGroup) tr.classList.add("group-row");const hasRowClick = (tableState.rowClickAsSource || []).some(function(binding) {const key = binding.table + "|" + binding.column + "|" + binding.sourceTable + "|" + binding.sourceColumn;const selected = state.rowClickSelections[key] || "";return selected !== "" && String(row._source[binding.sourceColumn] || row[binding.sourceColumn] || "") === selected;});if (hasRowClick) tr.classList.add("row-selected");frag.appendChild(tr);});}parts.tbody.appendChild(frag);renderPager(tableName, sorted.length);if (tableState.tfoot) {const footFrag = document.createDocumentFragment();let tr;if (tableState.footTemplateRow) {tr = tableState.footTemplateRow.cloneNode(true);replaceTemplateTokens(tr, tableName, tableState, {row: null,totals: totalsInfo.totals,rowTotal: totalsInfo.grandRowTotal});const tds = tr.querySelectorAll("td");tds.forEach(function(td, tdIndex) {const col = tableState.columns[tdIndex];if (col) td.setAttribute("data-col", col.key);});} else {tr = document.createElement("tr");tableState.columns.forEach(function(col) {const td = document.createElement("td");td.setAttribute("data-col", col.key);const baseValue = sorted.length ? (totalsInfo.totals[col.key] || 0) : (col.type === "number" ? 0 : "null");td.textContent = col.type === "number" ? formatValue(tableState, col, baseValue) : String(baseValue || "");tr.appendChild(td);});}tr.setAttribute("data-row-index", "0");footFrag.appendChild(tr);parts.tfoot.appendChild(footFrag);}state.tableSummaries[tableName] = {rowCount: sorted.length,firstRow: sorted[0] || {},totals: totalsInfo.totals,rowTotals: totalsInfo.rowTotals,grandRowTotal: totalsInfo.grandRowTotal,columns: tableState.columns};resolveTemplateTags();if (tableState.hooks.onRender) {tableState.hooks.onRender({ tableName: tableName, rowCount: sorted.length, data: sorted });}} catch (err) {console.error("[csvtable] Render failed for table:", tableName, err);}}function resolveTemplateTags() {try {const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);const pattern = /\{(\w+):(\w+)\}/g;const nodes = [];while (walker.nextNode()) {const node = walker.currentNode;if (pattern.test(node.nodeValue || "")) nodes.push(node);pattern.lastIndex = 0;}nodes.forEach(function(node) {const text = node.nodeValue || "";const replaced = text.replace(pattern, function(_, tableName, key) {const summary = state.tableSummaries[tableName];if (!summary) return "";if (key === "RowTotal") {const parentTr = node.parentElement && node.parentElement.closest("tr[data-row-index]");if (!parentTr) return "";const idx = parseInt(parentTr.getAttribute("data-row-index") || "-1", 10);const value = idx >= 0 ? (summary.rowTotals[idx] || 0) : 0;return String(value);}if (key.endsWith("Total")) {const colKey = key.slice(0, -5);const col = summary.columns.find(function(c) { return c.key === colKey; });if (!col) return "";const tableState = state.tables[tableName];return formatValue(tableState, col, summary.totals[colKey] || 0);}const col = summary.columns.find(function(c) { return c.key === key; });if (!col) return "";const tableState = state.tables[tableName];return formatValue(tableState, col, summary.firstRow[key] || "");});node.nodeValue = replaced;});} catch (err) {console.error("[csvtable] Tag resolution failed.", err);}}function setupFilters(runtimeConfig) {const filters = runtimeConfig.filters || [];filters.forEach(function(filterDef) {const tState = state.tables[filterDef.table];if (!tState) return;if (filterDef.trigger === "rowClick") {tState.filters.push(filterDef);const sourceState = state.tables[filterDef.sourceTable];if (!sourceState || !sourceState.el) {console.warn("[csvtable] Source table not found for rowClick filter:", filterDef.sourceTable);return;}if (!sourceState.rowClickAsSource) sourceState.rowClickAsSource = [];sourceState.rowClickAsSource.push(filterDef);if (!sourceState.el.dataset.csvtableRowClickBound) {const tbody = sourceState.el.querySelector("tbody");if (tbody) {tbody.addEventListener("click", function(evt) {const rowEl = evt.target && evt.target.closest("tr[data-row-index]");if (!rowEl || rowEl.classList.contains("no-data-row")) return;const idx = parseInt(rowEl.getAttribute("data-row-index") || "-1", 10);if (idx < 0) return;const rowData = sourceState.displayRows && sourceState.displayRows[idx];if (!rowData) return;(sourceState.rowClickAsSource || []).forEach(function(binding) {const value = String(rowData._source[binding.sourceColumn] || rowData[binding.sourceColumn] || "");const key = binding.table + "|" + binding.column + "|" + binding.sourceTable + "|" + binding.sourceColumn;if ((state.rowClickSelections[key] || "") === value) {state.rowClickSelections[key] = "";} else {state.rowClickSelections[key] = value;}const targetState = state.tables[binding.table];if (targetState && targetState.pager.enabled) targetState.pager.currentPage = 1;renderTable(binding.table);});renderTable(filterDef.sourceTable);});sourceState.el.dataset.csvtableRowClickBound = "true";}}return;}const selectEl = document.getElementById(filterDef.select);if (!selectEl) {console.warn("[csvtable] Select element not found:", filterDef.select);return;}if (!state.selectBindings[filterDef.select]) state.selectBindings[filterDef.select] = [];state.selectBindings[filterDef.select].push(filterDef.table);tState.filters.push(filterDef);if (filterDef.static !== true) {const values = new Set();state.source.rows.forEach(function(sourceRow) {const idx = state.headersIndex[filterDef.column];if (idx === undefined) return;const rowMap = { _source: {} };Object.keys(state.headersIndex).forEach(function(h) { rowMap._source[h] = getRowSourceValue(sourceRow, h); });if (!tState.staticPredicate(rowMap)) return;values.add(sourceRow[idx] || "");});const sortedValues = Array.from(values).sort(function(a, b) { return String(a).localeCompare(String(b)); });while (selectEl.firstChild) selectEl.removeChild(selectEl.firstChild);const allOpt = document.createElement("option");allOpt.value = "";allOpt.textContent = "All";selectEl.appendChild(allOpt);sortedValues.forEach(function(v) {const opt = document.createElement("option");opt.value = v;opt.textContent = v;selectEl.appendChild(opt);});}if (!selectEl.dataset.csvtableBound) {selectEl.addEventListener("change", function() {const tables = state.selectBindings[filterDef.select] || [];tables.forEach(function(name) {const renderState = state.tables[name];if (renderState && renderState.pager.enabled) renderState.pager.currentPage = 1;renderTable(name);});});selectEl.dataset.csvtableBound = "true";}});if (!document.body.dataset.csvtableResetBound) {document.body.addEventListener("click", function(evt) {const resetButton = evt.target && evt.target.closest('button[type="reset"]');if (!resetButton) return;filters.forEach(function(filterDef) {if (!filterDef.select) return;const selectEl = document.getElementById(filterDef.select);if (!selectEl) return;selectEl.value = "";});state.rowClickSelections = {};Object.keys(state.tables).forEach(function(name) {const tableState = state.tables[name];if (tableState && tableState.pager.enabled) tableState.pager.currentPage = 1;renderTable(name);});});document.body.dataset.csvtableResetBound = "true";}}function mergeDeclarativeConfig(baseConfig) {const runtime = {source: baseConfig.source,tables: Object.assign({}, baseConfig.tables || {}),filters: (baseConfig.filters || []).slice(),hooks: baseConfig.hooks || {},formatters: baseConfig.formatters || {}};const tableEls = Array.from(document.querySelectorAll("table[data-table-name]"));tableEls.forEach(function(tableEl) {const name = tableEl.getAttribute("data-table-name");if (!name || runtime.tables[name]) return;runtime.tables[name] = {columns: tableEl.getAttribute("data-columns") || "",staticFilters: tableEl.getAttribute("data-static-filters") || "",groupBy: tableEl.getAttribute("data-group-by") || null,agg: tableEl.getAttribute("data-agg") || "",tfoot: tableEl.getAttribute("data-tfoot") === "true",locale: tableEl.getAttribute("data-locale") || DEFAULT_LOCALE,pager: {enabled: tableEl.getAttribute("data-pager") === "true",rowsPerPage: parseInt(tableEl.getAttribute("data-rows-per-page") || "10", 10) || 10}};});const filterEls = Array.from(document.querySelectorAll("select[data-filter-table][data-filter-column]"));filterEls.forEach(function(selectEl) {const table = selectEl.getAttribute("data-filter-table");const column = selectEl.getAttribute("data-filter-column");if (!table || !column || !selectEl.id) return;const exists = runtime.filters.some(function(f) {return f.table === table && f.select === selectEl.id && f.column === column;});if (!exists) runtime.filters.push({ table: table, select: selectEl.id, column: column, static: false });});return runtime;}async function init(config) {try {const runtime = mergeDeclarativeConfig(config || {});const sourceOk = await loadSource(runtime.source);if (!sourceOk) return;Object.keys(runtime.tables || {}).forEach(function(tableName) {const def = runtime.tables[tableName] || {};const tableEl = document.querySelector('table[data-table-name="' + tableName + '"]');if (!tableEl) {console.warn("[csvtable] Table element not found for:", tableName);return;}const columns = parseColumns(def.columns || "");columns.forEach(function(col) {if (state.headersIndex[col.sourceHeader] === undefined) {console.warn("[csvtable] Column header not found in CSV:", col.sourceHeader);}});const staticFilters = parseStaticFilters(def.staticFilters || "");const bodyTemplateRow = tableEl.querySelector("tbody tr") ? tableEl.querySelector("tbody tr").cloneNode(true) : null;const footTemplateRow = tableEl.querySelector("tfoot tr") ? tableEl.querySelector("tfoot tr").cloneNode(true) : null;state.tables[tableName] = {el: tableEl,columns: columns,staticPredicate: staticFilterPredicate(staticFilters),aggMap: parseAgg(def.agg || ""),groupBy: def.groupBy || null,tfoot: Boolean(def.tfoot),locale: def.locale || DEFAULT_LOCALE,formatters: runtime.formatters || {},hooks: runtime.hooks || {},filters: [],rowClickAsSource: [],displayRows: [],bodyTemplateRow: bodyTemplateRow,footTemplateRow: footTemplateRow,sort: { columnIndex: null, direction: null },pager: {enabled: Boolean(def.pager && def.pager.enabled),rowsPerPage: parseInt(def.pager && def.pager.rowsPerPage, 10) || 10,currentPage: 1,pageCount: 1},sortTypes: Array.from(tableEl.querySelectorAll("thead th")).map(function(th) {const t = th.getAttribute("data-sort-type") || "text";return t === "number" ? "number" : "text";})};setupSort(tableName, tableEl);});setupFilters(runtime);Object.keys(state.tables).forEach(function(tableName) {renderTable(tableName);});} catch (err) {console.error("[csvtable] Init failed.", err);}}document.addEventListener("DOMContentLoaded", function() {init(CONFIG);});})(typeof window !== "undefined" && window.CSVTABLE_CONFIG ? window.CSVTABLE_CONFIG : CSVTABLE_CONFIG);
